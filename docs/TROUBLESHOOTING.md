# Устранение неполадок / Troubleshooting Guide

Полное руководство по диагностике и решению проблем с CAN LED контроллером.

## Содержание

1. [Быстрая диагностика](#быстрая-диагностика)
2. [Проблемы с LED](#проблемы-с-led)
3. [Проблемы с CAN](#проблемы-с-can)
4. [Проблемы с WiFi](#проблемы-с-wifi)
5. [Проблемы с прошивкой](#проблемы-с-прошивкой)
6. [Проблемы с эмулятором](#проблемы-с-эмулятором)
7. [Расширенная диагностика](#расширенная-диагностика)

---

## Быстрая диагностика

### Дерево принятия решений

```
LED не работает?
│
├─► LED вообще не светится
│   └─► Проверьте: питание, GPIO4, подключение DIN
│
├─► LED светится, но неправильно
│   └─► Проверьте: CAN данные, протокол, провода
│
└─► LED показывает ошибку (красный/жёлтый)
    └─► Смотрите раздел "LED паттерны ошибок"
```

### LED паттерны ошибок

| Паттерн | Значение | Решение |
|---------|----------|---------|
| Мигающий красный (4 Hz) | Ошибка CAN шины | Проверьте подключение CAN |
| Красно-белый строб | Низкое давление масла | Проверьте двигатель! |
| Тусклый жёлтый (3 Hz) | Устаревшие данные | Нет CAN сообщений 2+ сек |
| RGB цикл на LED #1 | Самотест | Нормально при старте |

### Serial Monitor — первый шаг

```bash
pio device monitor -b 115200
```

**Нормальный вывод:**
```
TWAI driver installed
CAN bus started at 1 Mbps
WiFi AP started: CANLED_AP
HTTP server started on port 80
LED self-test complete
CAN: ID 0x5F0 DLC6 DATA 20 03 00 00 E8 03
```

**Проблемы видны сразу:**
```
ERROR: Failed to install TWAI driver
ERROR: Failed to start CAN bus
ERROR: WiFi AP start failed
```

---

## Проблемы с LED

### LED не светится вообще

**Симптом:** Лента полностью тёмная, даже при старте нет самотеста.

**Возможные причины и решения:**

```
1. НЕТ ПИТАНИЯ LED
   ┌─────────────────────────────────────────┐
   │ Проверьте:                              │
   │ - Напряжение на +5V ленты (мультиметр)  │
   │ - Надёжность контакта                   │
   │ - Предохранитель (если есть)            │
   │ - Блок питания включён                  │
   └─────────────────────────────────────────┘

2. НЕ ПОДКЛЮЧЕН DIN
   ┌─────────────────────────────────────────┐
   │ Проверьте:                              │
   │ - GPIO4 → DIN                           │
   │ - Правильный конец ленты (IN, не OUT)   │
   │ - Целостность провода                   │
   └─────────────────────────────────────────┘

3. ОБЩИЙ GND
   ┌─────────────────────────────────────────┐
   │ Проверьте:                              │
   │ - GND ESP32 соединён с GND ленты        │
   │ - GND блока питания соединён            │
   └─────────────────────────────────────────┘

4. НЕПРАВИЛЬНЫЙ GPIO
   ┌─────────────────────────────────────────┐
   │ В src/config.h:                         │
   │ constexpr uint8_t LED_PIN = 4;          │
   │ Убедитесь, что используете GPIO4        │
   └─────────────────────────────────────────┘
```

### LED светится случайными цветами

**Симптом:** Хаотичное мерцание, случайные цвета.

```
1. ПРОБЛЕМА СИГНАЛА ДАННЫХ
   ┌─────────────────────────────────────────┐
   │ Решения:                                │
   │ - Добавьте резистор 220-470Ω в линию DIN│
   │ - Укоротите провод данных (< 30 см)     │
   │ - Добавьте level shifter 3.3V → 5V      │
   │ - Экранируйте провод от помех           │
   └─────────────────────────────────────────┘

2. ПОМЕХИ ПО ПИТАНИЮ
   ┌─────────────────────────────────────────┐
   │ Решения:                                │
   │ - Добавьте конденсатор 1000µF на +5V    │
   │ - Используйте качественный БП           │
   │ - Проложите провода отдельно от помех   │
   └─────────────────────────────────────────┘
```

### Только часть LED работает

**Симптом:** Работают первые N светодиодов.

```
1. ПРОВЕРЬТЕ LED_COUNT
   ┌─────────────────────────────────────────┐
   │ В src/config.h:                         │
   │ constexpr uint8_t LED_COUNT = 60;       │
   │                                         │
   │ Значение должно соответствовать         │
   │ реальному количеству LED                │
   └─────────────────────────────────────────┘

2. БИТЫЙ LED В ЦЕПОЧКЕ
   ┌─────────────────────────────────────────┐
   │ Диагностика:                            │
   │ - Отключите ленту после рабочего LED    │
   │ - Если остальные заработали — битый LED │
   │ - Замените секцию или перепаяйте        │
   └─────────────────────────────────────────┘

3. ПАДЕНИЕ НАПРЯЖЕНИЯ
   ┌─────────────────────────────────────────┐
   │ Для длинных лент:                       │
   │ - Инъекция питания каждые 50-100 LED    │
   │ - Используйте более толстые провода     │
   │ - Измерьте напряжение в конце ленты     │
   │   (должно быть > 4.5V)                  │
   └─────────────────────────────────────────┘
```

---

## Проблемы с CAN

### Нет приёма CAN сообщений

**Симптом:** Serial monitor не показывает "CAN: ID..."

```
1. ФИЗИЧЕСКОЕ ПОДКЛЮЧЕНИЕ
   ┌─────────────────────────────────────────┐
   │ Проверьте:                              │
   │ - CAN_H к CAN_H                         │
   │ - CAN_L к CAN_L                         │
   │ - GND к GND (общая земля!)              │
   │                                         │
   │ ВАЖНО: CAN_H и CAN_L НЕ                 │
   │ взаимозаменяемы!                        │
   └─────────────────────────────────────────┘

2. ТЕРМИНИРОВАНИЕ
   ┌─────────────────────────────────────────┐
   │ Измерьте сопротивление CAN_H - CAN_L:   │
   │                                         │
   │ ~60Ω  = OK (два терминатора)            │
   │ ~120Ω = Добавьте терминатор             │
   │ ∞     = Нет терминаторов (добавьте 2)   │
   │ <50Ω  = КЗ или лишние терминаторы       │
   └─────────────────────────────────────────┘

3. СКОРОСТЬ CAN
   ┌─────────────────────────────────────────┐
   │ Прошивка настроена на 1 Mbps            │
   │                                         │
   │ Убедитесь, что ECU/источник тоже        │
   │ работает на 1 Mbps (1000 kbps)          │
   └─────────────────────────────────────────┘

4. ECU НЕ ОТПРАВЛЯЕТ ДАННЫЕ
   ┌─────────────────────────────────────────┐
   │ Для Link ECU:                           │
   │ - Включите Generic Dash Stream          │
   │ - Проверьте CAN output в PCLink         │
   │                                         │
   │ Для других ECU:                         │
   │ - Настройте CAN вывод телеметрии        │
   └─────────────────────────────────────────┘
```

### Ошибка "CAN bus BUS-OFF"

**Симптом:** LED мигает красным, в Serial: "CAN bus in BUS-OFF"

```
Причины BUS-OFF:
┌─────────────────────────────────────────┐
│ 1. Неправильная полярность CAN_H/CAN_L  │
│ 2. Короткое замыкание в проводке        │
│ 3. Несовпадение скоростей CAN           │
│ 4. Слишком много ошибок на шине         │
│ 5. Отсутствие терминаторов              │
└─────────────────────────────────────────┘

Решение:
1. Отключите питание
2. Проверьте все соединения
3. Проверьте полярность
4. Измерьте терминирование
5. Включите снова
6. Прошивка попытается восстановиться автоматически
```

### Неправильные значения данных

**Симптом:** LED реагирует, но показывает неверные данные.

```
1. НЕСОВПАДЕНИЕ ПРОТОКОЛА
   ┌─────────────────────────────────────────┐
   │ В src/config.h:                         │
   │ #define CAN_PROTOCOL 1                  │
   │                                         │
   │ Должен совпадать с настройками ECU:     │
   │ 0 = Custom Protocol                     │
   │ 1 = Link Generic Dashboard              │
   │ 2 = Link Generic Dashboard 2            │
   └─────────────────────────────────────────┘

2. НЕПРАВИЛЬНЫЙ BYTE ORDER
   ┌─────────────────────────────────────────┐
   │ Прошивка ожидает little-endian          │
   │                                         │
   │ RPM 5500 = 0x157C                       │
   │ Должно быть: 7C 15 (младший байт первый)│
   │                                         │
   │ Если ваш ECU отправляет big-endian,     │
   │ нужно модифицировать can_handler.cpp    │
   └─────────────────────────────────────────┘
```

---

## Проблемы с WiFi

### WiFi AP не запускается

**Симптом:** Сеть CANLED_AP не видна.

```
1. ПРОВЕРЬТЕ SERIAL MONITOR
   ┌─────────────────────────────────────────┐
   │ Ищите строки:                           │
   │ "WiFi AP started: CANLED_AP" = OK       │
   │ "ERROR: WiFi AP start failed" = Проблема│
   └─────────────────────────────────────────┘

2. ПРОВЕРЬТЕ ПАРОЛЬ
   ┌─────────────────────────────────────────┐
   │ В src/config.h:                         │
   │ constexpr char WIFI_PASSWORD[] = ...    │
   │                                         │
   │ Минимум 8 символов!                     │
   └─────────────────────────────────────────┘

3. ПОПРОБУЙТЕ ПЕРЕЗАГРУЗКУ
   ┌─────────────────────────────────────────┐
   │ Нажмите кнопку RST на плате             │
   │ или переподключите USB                  │
   └─────────────────────────────────────────┘
```

### Не открывается веб-интерфейс

**Симптом:** Подключились к WiFi, но http://192.168.4.1/ не работает.

```
1. ПРОВЕРЬТЕ IP АДРЕС
   ┌─────────────────────────────────────────┐
   │ Стандартный: 192.168.4.1                │
   │                                         │
   │ Проверьте назначенный IP:               │
   │ - Windows: ipconfig                     │
   │ - Linux/Mac: ifconfig или ip addr       │
   │                                         │
   │ Gateway должен быть 192.168.4.1         │
   └─────────────────────────────────────────┘

2. ПРОВЕРЬТЕ HTTP СЕРВЕР
   ┌─────────────────────────────────────────┐
   │ В Serial monitor должно быть:           │
   │ "HTTP server started on port 80"        │
   └─────────────────────────────────────────┘

3. ПОПРОБУЙТЕ ДРУГОЙ БРАУЗЕР
   ┌─────────────────────────────────────────┐
   │ Некоторые браузеры кешируют DNS         │
   │ Попробуйте инкогнито/приватный режим    │
   └─────────────────────────────────────────┘

4. ПРОВЕРЬТЕ FIREWALL
   ┌─────────────────────────────────────────┐
   │ Временно отключите firewall             │
   │ Или разрешите порт 80                   │
   └─────────────────────────────────────────┘
```

---

## Проблемы с прошивкой

### Ошибка компиляции

```
Error: ... 'LED_COUNT' was not declared

Решение:
- Убедитесь, что src/config.h существует
- Проверьте include в файлах

Error: ... cannot open source file "FastLED.h"

Решение:
- pio lib install "FastLED"
- или: pio run (автоустановка)
```

### Ошибка прошивки

```
Error: Failed to connect to ESP32

Решения:
1. Проверьте USB кабель (данные, не только зарядка)
2. Проверьте порт:
   - Linux: /dev/ttyUSB0 или /dev/ttyACM0
   - macOS: /dev/cu.usbserial-*
   - Windows: COM3, COM4, etc.

3. Установите драйверы CH340/CP2102

4. Зажмите BOOT при подключении:
   - Зажмите BOOT
   - Подключите USB
   - Отпустите BOOT
   - Прошейте
```

### Watchdog reset

**Симптом:** Устройство перезагружается каждые 30 сек.

```
В Serial monitor:
"Guru Meditation Error" или "Watchdog timeout"

Причины:
1. Бесконечный цикл в коде
2. Блокирующая операция слишком долгая
3. Проблема с памятью

Решение:
Отключите watchdog для отладки:
#define ENABLE_WATCHDOG false
```

---

## Проблемы с эмулятором

### "python-can not installed"

```bash
pip install python-can

# Если ошибка прав:
pip install --user python-can

# Или через pip3:
pip3 install python-can
```

### "Permission denied" (Linux)

```bash
# Добавьте в группу dialout
sudo usermod -a -G dialout $USER

# ВАЖНО: перезайдите в систему!
logout
# или перезагрузитесь
```

### Адаптер не подключается

```
1. ПРОВЕРЬТЕ ОПРЕДЕЛЕНИЕ УСТРОЙСТВА
   ┌─────────────────────────────────────────┐
   │ Linux:                                  │
   │ $ ls /dev/ttyUSB* /dev/ttyACM*          │
   │ $ dmesg | tail -20                      │
   │                                         │
   │ Windows:                                │
   │ Device Manager → Ports (COM & LPT)      │
   │                                         │
   │ macOS:                                  │
   │ $ ls /dev/cu.usb*                       │
   └─────────────────────────────────────────┘

2. УСТАНОВИТЕ ДРАЙВЕРЫ
   ┌─────────────────────────────────────────┐
   │ CH340: https://ch340drivers.com/        │
   │ CP2102: Silicon Labs VCP drivers        │
   │ FTDI: FTDI D2XX drivers                 │
   └─────────────────────────────────────────┘

3. SLCAN АДАПТЕР ЗАВИС
   ┌─────────────────────────────────────────┐
   │ Сброс адаптера (Linux):                 │
   │ $ stty -F /dev/ttyUSB0 raw              │
   │ $ echo -e "C\r" > /dev/ttyUSB0          │
   │ $ echo -e "S8\r" > /dev/ttyUSB0         │
   │ $ echo -e "O\r" > /dev/ttyUSB0          │
   └─────────────────────────────────────────┘
```

### Сообщения отправляются, но LED не реагирует

```
Чеклист:
[ ] Протокол в эмуляторе = CAN_PROTOCOL в прошивке
[ ] Bitrate = 1000000 (1 Mbps)
[ ] CAN_H к CAN_H, CAN_L к CAN_L
[ ] GND соединены
[ ] Терминатор 120Ω установлен
[ ] Serial monitor показывает "CAN: ID 0x..."
```

---

## Расширенная диагностика

### Анализ CAN трафика

```bash
# Linux с SocketCAN:

# Создайте виртуальный интерфейс
sudo modprobe vcan
sudo ip link add dev vcan0 type vcan
sudo ip link set up vcan0

# Запустите candump
candump vcan0

# В другом терминале отправьте тестовое сообщение
cansend vcan0 100#4B

# Вы должны увидеть:
vcan0  100   [1]  4B
```

### Осциллограф на CAN

```
Нормальный сигнал CAN:

CAN_H: ─────┐   ┌────┐   ┌────┐   ┌─────
            │   │    │   │    │   │
         3.5V ── │    │   │    │   │
            │   │    │   │    │   │
CAN_L: ─────┘   └────┘   └────┘   └─────
         1.5V ──

Recessive (idle): CAN_H ≈ CAN_L ≈ 2.5V
Dominant (bit 0): CAN_H ≈ 3.5V, CAN_L ≈ 1.5V
Differential: ~2V
```

### Проверка памяти

```cpp
// Добавьте в loop() для мониторинга:
Serial.printf("Free heap: %d bytes\n", ESP.getFreeHeap());

// Норма: > 100KB свободно
// Проблема: < 50KB или постоянно падает
```

### Температурный мониторинг

```cpp
// ESP32 внутренняя температура:
#include "driver/temp_sensor.h"

float tsens_out;
temp_sensor_read_celsius(&tsens_out);
Serial.printf("ESP32 temp: %.1f°C\n", tsens_out);

// Норма: < 70°C
// Проблема: > 85°C (throttling)
```

---

## Контакты и поддержка

### Если ничего не помогло:

1. **Создайте Issue на GitHub** с:
   - Описанием проблемы
   - Выводом Serial Monitor
   - Фото подключения
   - Версией прошивки

2. **Приложите конфигурацию:**
   ```bash
   cat src/config.h
   pio run -t envdump
   ```

3. **Опишите окружение:**
   - ОС и версия
   - Версия PlatformIO
   - Тип CAN адаптера
   - Тип LED ленты

---

**Удачной отладки!**
