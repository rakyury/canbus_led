# Подробное руководство по сборке / Detailed Hardware Setup

Полное руководство по подключению и настройке аппаратной части CAN LED контроллера.

## Содержание

1. [Обзор компонентов](#обзор-компонентов)
2. [TTGO T-CAN48](#ttgo-t-can48)
3. [LED лента](#led-лента)
4. [CAN шина](#can-шина)
5. [Схемы подключения](#схемы-подключения)
6. [Питание](#питание)
7. [Монтаж в автомобиле](#монтаж-в-автомобиле)

---

## Обзор компонентов

### Минимальный набор

```
┌─────────────────────────────────────────────────────────────┐
│                    МИНИМАЛЬНАЯ КОНФИГУРАЦИЯ                 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌──────────────┐     ┌───────────────────────────────┐   │
│   │ TTGO T-CAN48 │     │   LED Strip WS2812B (60 LED)  │   │
│   │              │     │                               │   │
│   │  ┌───┐ ┌───┐ │     │  ○○○○○○○○○○○○○○○○○○○○○○○○○○○   │   │
│   │  │USB│ │CAN│ │     │                               │   │
│   │  └───┘ └───┘ │     └───────────────────────────────┘   │
│   └──────────────┘                                          │
│          │                        │                         │
│          │  GPIO4 ────────────────┤ DIN                     │
│          │  5V ───────────────────┤ +5V                     │
│          │  GND ──────────────────┤ GND                     │
│          │                                                  │
│          │  CAN_H ────────────────┐                         │
│          │  CAN_L ────────────────┤ К CAN шине автомобиля   │
│          │  GND ──────────────────┘                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### Расширенный набор (рекомендуется)

| Компонент | Назначение | Рекомендация |
|-----------|------------|--------------|
| Резистор 220-470Ω | Защита линии данных LED | В линию DIN |
| Конденсатор 1000µF | Фильтрация питания LED | Параллельно питанию |
| Level Shifter 3.3V→5V | Надёжная передача данных | Между GPIO и DIN |
| Резистор 120Ω | CAN терминатор | Между CAN_H и CAN_L |
| TVS диоды | Защита от ESD | На линиях CAN |
| Предохранитель 5A | Защита питания | В цепь +12V |

---

## TTGO T-CAN48

### Описание платы

```
              TTGO T-CAN48 - вид сверху
    ┌─────────────────────────────────────────┐
    │                                         │
    │  ┌─────┐                      ┌─────┐   │
    │  │ ANT │ WiFi/BT антенна     │ RST │   │
    │  └─────┘                      └─────┘   │
    │                                         │
    │  ┌─────────────────────────────────┐   │
    │  │                                 │   │
    │  │           ESP32-WROOM           │   │
    │  │                                 │   │
    │  └─────────────────────────────────┘   │
    │                                         │
    │  GPIO21 ○  TX (CAN)                     │
    │  GPIO22 ○  RX (CAN)                     │
    │  GPIO4  ○  LED Data                     │
    │                                         │
    │  ┌─────────────────┐  ┌─────────────┐   │
    │  │   CAN Terminal  │  │   USB-C     │   │
    │  │  ┌───┬───┬───┐  │  │             │   │
    │  │  │ H │ L │GND│  │  └─────────────┘   │
    │  │  └───┴───┴───┘  │                    │
    │  └─────────────────┘                    │
    │                                         │
    └─────────────────────────────────────────┘
```

### Распиновка

| GPIO | Функция | Описание |
|------|---------|----------|
| GPIO21 | CAN_TX | Передача CAN (к трансиверу) |
| GPIO22 | CAN_RX | Приём CAN (от трансивера) |
| GPIO4 | LED_DATA | Управление адресной лентой |
| 5V | Power | Питание от USB или внешнее |
| 3.3V | Power | Логический уровень ESP32 |
| GND | Ground | Общая земля |

### Встроенный CAN трансивер

- **Чип**: SN65HVD230 или аналог
- **Скорость**: до 1 Mbps
- **Напряжение**: 3.3V логика, 5V толерантный
- **Терминатор**: На некоторых ревизиях есть переключатель 120Ω

### Переключатели и джамперы

Проверьте вашу ревизию платы:

```
Ревизия с переключателем терминатора:
┌──────────────────────┐
│  120Ω  [ON]─[OFF]    │  ← Переключите ON если это
│  TERM                │    конец CAN линии
└──────────────────────┘
```

---

## LED лента

### Совместимые типы

| Тип | Напряжение | Плотность | Рекомендация |
|-----|------------|-----------|--------------|
| **WS2812B** | 5V | 30-144 LED/m | ✅ Лучший выбор |
| **WS2811** | 12V | 30-60 LED/m | ✅ Для 12V систем |
| **SK6812** | 5V | 30-144 LED/m | ✅ С RGBW |
| **APA102** | 5V | 30-144 LED/m | ⚠️ Требует 2 провода данных |

### Расчёт питания

```
Формула: Ток = Кол-во_LED × 60mA (максимум)

Примеры:
┌──────────────┬────────────────┬───────────────┐
│ Кол-во LED   │ Макс. ток      │ БП            │
├──────────────┼────────────────┼───────────────┤
│ 30 LED       │ 1.8A           │ 5V/2A         │
│ 60 LED       │ 3.6A           │ 5V/5A         │
│ 144 LED      │ 8.6A           │ 5V/10A        │
│ 300 LED      │ 18A            │ 5V/20A        │
└──────────────┴────────────────┴───────────────┘

* На практике потребление ~30-50% от максимума
```

### Правильное подключение

```
                    Резистор          Лента WS2812B
ESP32              220-470Ω
GPIO4 ○───────────[═══════]──────────○ DIN
                                      │
                                      │    ○○○○○○○○○○○○○○○○○
                                      │    LED 1  ...  LED 60
                                      │
5V    ○──────────────────────────────○ +5V
                     │
                    ═══ 1000µF
                     │
GND   ○──────────────┴───────────────○ GND
```

### Level Shifter (рекомендуется)

ESP32 выдаёт 3.3V логику, а WS2812B ожидает 5V:

```
                   Level Shifter
                   (74HCT125 или аналог)
ESP32              ┌─────────────┐         Лента
GPIO4 ○────────────┤ IN     OUT ├─────────○ DIN
3.3V  ○────────────┤ LV      HV ├─────────○ 5V
GND   ○────────────┤ GND    GND ├─────────○ GND
                   └─────────────┘
```

### Инъекция питания для длинных лент

При длине >2м или >100 LED добавляйте питание:

```
БП 5V
  │
  ├──────────○ Начало ленты (+5V)
  │
  ├──────────○ Середина ленты (+5V)  ← Инъекция
  │
  └──────────○ Конец ленты (+5V)     ← Инъекция

GND подключается также в нескольких точках
```

---

## CAN шина

### Основы CAN

```
                     CAN шина
    ┌────────────────────────────────────────────┐
    │                                            │
   ─┴─                                          ─┴─
   120Ω                                         120Ω
   ─┬─                                          ─┬─
    │     ┌───────┐   ┌───────┐   ┌───────┐     │
────┼─────┤ ECU   ├───┤ Node  ├───┤ T-CAN ├─────┼────
    │     └───────┘   └───────┘   └───────┘     │
    │                                            │
    └────────────────────────────────────────────┘

    CAN_H ────────────────────────────────────────
    CAN_L ────────────────────────────────────────

    * Терминаторы 120Ω только на концах шины!
```

### Подключение к автомобилю

#### Вариант 1: OBD-II порт

```
OBD-II разъём (вид спереди)
┌───────────────────────────────┐
│  1   2   3   4   5   6   7   8│
│                               │
│  9  10  11  12  13  14  15  16│
└───────────────────────────────┘

Pin 6  = CAN_H (High-Speed CAN)
Pin 14 = CAN_L (High-Speed CAN)
Pin 4  = Chassis Ground
Pin 5  = Signal Ground
Pin 16 = +12V Battery
```

#### Вариант 2: Прямое подключение к ECU

```
ECU Link / Generic
┌─────────────────┐
│ CAN_H  ●────────┼───── К T-CAN48 CAN_H
│ CAN_L  ●────────┼───── К T-CAN48 CAN_L
│ GND    ●────────┼───── К T-CAN48 GND
│ +12V   ●────────┼───── (опционально для питания)
└─────────────────┘
```

### Терминирование

**Когда НЕ нужен терминатор 120Ω:**
- Подключение к существующей шине через OBD-II
- На шине уже есть 2 терминатора

**Когда НУЖЕН терминатор:**
- Прямое подключение к ECU
- Конец линии CAN
- Длинная линия (>2м)

```
Проверка терминирования мультиметром:

Измерьте сопротивление между CAN_H и CAN_L
при выключенном зажигании:

~60Ω  = Правильно (два терминатора по 120Ω параллельно)
~120Ω = Один терминатор (добавьте второй)
∞     = Нет терминаторов (добавьте оба)
```

---

## Схемы подключения

### Базовая схема

```
                          ┌─────────────────────────────────────┐
                          │          TTGO T-CAN48               │
                          │                                     │
              ┌───────────┤ USB-C (питание + программирование)  │
              │           │                                     │
              │     ┌─────┤ GPIO4                               │
              │     │     │                                     │
              │     │     │ 5V ─────────────┐                   │
              │     │     │                 │                   │
              │     │     │ GND ────────────┼───┐               │
   USB        │     │     │                 │   │               │
   Кабель     │     │     │ CAN_H ──────────┼───┼───┐           │
              │     │     │                 │   │   │           │
              │     │     │ CAN_L ──────────┼───┼───┼───┐       │
              │     │     │                 │   │   │   │       │
              │     │     │ GND ────────────┼───┼───┼───┼───┐   │
              │     │     │                 │   │   │   │   │   │
              │     │     └─────────────────┼───┼───┼───┼───┼───┘
              │     │                       │   │   │   │   │
              ▼     │                       │   │   │   │   │
           ┌──┴──┐  │     ┌─────────────────┼───┼───┼───┼───┼────┐
           │ PC  │  │     │ WS2812B LED     │   │   │   │   │    │
           └─────┘  │     │                 │   │   │   │   │    │
                    │     │ DIN ◄───────────┘   │   │   │   │    │
                    │     │                     │   │   │   │    │
                    └─────│────►[220Ω]──────────┘   │   │   │    │
                          │                        │   │   │    │
                          │ +5V ◄──────────────────┘   │   │    │
                          │                            │   │    │
                          │ GND ◄──────────────────────┘   │    │
                          │                                │    │
                          └────────────────────────────────┼────┘
                                                           │
                                                           │
                          ┌────────────────────────────────┼────┐
                          │ CAN шина автомобиля            │    │
                          │                                │    │
                          │ CAN_H ◄────────────────────────┘    │
                          │                                     │
                          │ CAN_L ◄─────────────────────────────│───
                          │                                     │
                          │ GND ◄───────────────────────────────│───
                          │                                     │
                          └─────────────────────────────────────┘
```

### Схема с внешним питанием

```
                    БП 5V/5A                    БП 12V (авто)
                    ┌──────┐                   ┌──────┐
                    │ +5V ─┼───┬───────────────┼─ ACC │
                    │      │   │               │      │
                    │ GND ─┼───┼───┐           │ GND ─┼───┐
                    └──────┘   │   │           └──────┘   │
                               │   │                      │
     ┌─────────────────────────┼───┼──────────────────────┼──────┐
     │                         │   │                      │      │
     │  ┌──────────────┐       │   │    ┌──────────────┐  │      │
     │  │ TTGO T-CAN48 │       │   │    │   ECU Link   │  │      │
     │  │              │       │   │    │              │  │      │
     │  │ 5V ◄─────────┼───────┘   │    │ CAN_H ◄──────┼──┼──────│──
     │  │              │           │    │              │  │      │
     │  │ GND ◄────────┼───────────┴────│─► GND       │  │      │
     │  │              │                │              │  │      │
     │  │ CAN_H ◄──────┼────────────────│─► CAN_H     │  │      │
     │  │              │                │              │  │      │
     │  │ CAN_L ◄──────┼────────────────│─► CAN_L     │  │      │
     │  │              │                │              │  │      │
     │  │ GPIO4 ───────┼──►[220Ω]──┐    └──────────────┘  │      │
     │  │              │           │                      │      │
     │  └──────────────┘           │                      │      │
     │                             │                      │      │
     │  ┌──────────────────────────┴──────────────────┐   │      │
     │  │ WS2812B LED Strip (60 LED)                  │   │      │
     │  │                                             │   │      │
     │  │ DIN ◄────────────────────────────────────────   │      │
     │  │                                             │   │      │
     │  │ +5V ◄───────────────────────────────────────────┘      │
     │  │                                             │          │
     │  │ GND ◄──────────────────────────────────────────────────┘
     │  │                                             │
     │  └─────────────────────────────────────────────┘
     │
     └───────────────────────────────────────────────────────────┘
                              Корпус / Шасси
```

---

## Питание

### От USB (только для тестов)

```
Максимум: 500mA (USB 2.0) или 900mA (USB 3.0)
Достаточно для: ~10-15 LED на полной яркости

USB ─────► TTGO T-CAN48 ─────► LED (до 15 шт)
```

### От внешнего 5V БП

```
Рекомендуется для: 30+ LED

           ┌─────────────┐
           │ БП 5V/5A    │
           │             │
           │ +5V ────────┼───┬──► LED +5V
           │             │   │
           │             │   └──► TTGO 5V (опц.)
           │             │
           │ GND ────────┼───┬──► LED GND
           │             │   │
           │             │   └──► TTGO GND
           └─────────────┘
```

### От бортовой сети 12V

```
Используйте DC-DC преобразователь!

12V (ACC) ────► DC-DC 12V→5V ────► LED +5V
                    │
                    └────────────► TTGO 5V
```

**Рекомендуемые DC-DC:**
- LM2596 модуль (до 3A)
- Mini360 (до 1.8A)
- XL4015 (до 5A)

### Защита от обратной полярности

```
          ┌─────┐
+12V ─────┤FUSE ├────►──┤ D1 ├──────► К DC-DC
          └─────┘         │
                     (P-FET или
                      диод Шоттки)
GND ──────────────────────┴─────────► К DC-DC
```

---

## Монтаж в автомобиле

### Рекомендуемые места установки

```
     Салон автомобиля (вид сверху)
┌─────────────────────────────────────┐
│                                     │
│  ┌─────┐              ┌─────────┐   │
│  │     │              │ Консоль │   │
│  │ LED │◄─── Под      │         │   │
│  │Strip│    торпедой  │ ┌─────┐ │   │
│  │     │              │ │T-CAN│ │   │ ◄── За консолью
│  └─────┘              │ └─────┘ │   │     или под сиденьем
│                       └─────────┘   │
│  ┌───────────────────────────────┐  │
│  │         Торпедо               │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───┐                       ┌───┐  │
│  │   │                       │   │  │
│  │   │                       │   │  │
│  └───┘                       └───┘  │
│   Водитель               Пассажир   │
└─────────────────────────────────────┘
```

### Советы по монтажу

1. **Контроллер:**
   - Избегайте мест с высокой температурой
   - Обеспечьте доступ к USB для обновлений
   - Закрепите стяжками или двусторонним скотчем

2. **LED лента:**
   - Используйте алюминиевый профиль для отвода тепла
   - Обеспечьте ровную поверхность
   - Защитите от влаги (силиконовая лента)

3. **Провода:**
   - Используйте автомобильные разъёмы
   - Защитите гофрой или термоусадкой
   - Избегайте острых краёв

4. **Питание:**
   - Подключайте к ACC (включается с зажиганием)
   - Используйте предохранитель!
   - Проложите провода вдали от источников помех

### Пример установки

```
                              Торпедо
    ┌─────────────────────────────────────────────────┐
    │░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│ ← LED под торпедо
    │                                                 │
    │    Контроллер      ┌───────────────────┐        │
    │    ┌───────┐       │    Центральная    │        │
    │    │T-CAN48├───────│    консоль        │        │
    │    │  +    │       │                   │        │
    │    │DC-DC  │       │    OBD-II ●───────┼────────│─► К OBD
    │    └───────┘       └───────────────────┘        │
    │         │                                       │
    │    К ACC +12V                                   │
    │                                                 │
    └─────────────────────────────────────────────────┘
```

---

## Проверка установки

### Чек-лист перед первым включением

- [ ] LED лента подключена к GPIO4
- [ ] Питание LED: +5V и GND
- [ ] CAN_H и CAN_L подключены правильно
- [ ] GND подключена к шасси/ECU
- [ ] Терминатор установлен (если нужен)
- [ ] Предохранитель в цепи питания
- [ ] Провода защищены и закреплены
- [ ] Нет коротких замыканий (проверить мультиметром)

### Порядок включения

1. Подключите USB к компьютеру
2. Откройте Serial Monitor
3. Убедитесь в успешной загрузке
4. Включите зажигание автомобиля
5. Проверьте приём CAN данных
6. Проверьте LED индикацию

---

**Следующий шаг:** [Руководство по эмулятору](EMULATOR_GUIDE.md)
