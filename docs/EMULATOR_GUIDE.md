# Руководство по CAN эмулятору / CAN Emulator Guide

Полное руководство по использованию CAN эмулятора для тестирования LED контроллера.

## Содержание

1. [Введение](#введение)
2. [Установка](#установка)
3. [Интерфейс приложения](#интерфейс-приложения)
4. [Подключение](#подключение)
5. [Протоколы](#протоколы)
6. [Конфигурация сообщений](#конфигурация-сообщений)
7. [Примеры использования](#примеры-использования)
8. [Продвинутые возможности](#продвинутые-возможности)
9. [Устранение проблем](#устранение-проблем)

---

## Введение

CAN эмулятор позволяет тестировать LED контроллер без реального автомобиля. Вы можете:

- Отправлять любые CAN сообщения
- Симулировать различные режимы работы двигателя
- Тестировать визуальные эффекты LED ленты
- Отлаживать интеграцию с ECU
- Записывать и воспроизводить последовательности

### Системные требования

- Python 3.8 или выше
- USB-CAN адаптер (CANable, USBtin, PCAN и др.)
- Операционная система: Windows, Linux или macOS

---

## Установка

### 1. Установка Python

```bash
# Проверка версии Python
python --version  # Должно быть 3.8+

# Если Python не установлен:
# Windows: https://www.python.org/downloads/
# Linux: sudo apt install python3 python3-pip
# macOS: brew install python3
```

### 2. Установка зависимостей

```bash
cd tools/can_emulator
pip install -r requirements.txt
```

Это установит:
- `python-can` — библиотека для работы с CAN шиной

### 3. Запуск эмулятора

```bash
python can_emulator.py
```

При запуске откроется GUI приложение:

```
┌─────────────────────────────────────────────────────────────────────┐
│  CAN Bus Emulator - CANBUS LED Controller                      [─][□][×] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────┐ ┌─────────────────────────┐ ┌────────────────┐ │
│  │ CAN Connection  │ │  Message Configuration  │ │ Send Sequence  │ │
│  │                 │ │                         │ │                │ │
│  │ Interface:      │ │  ┌──────────────────┐   │ │ [x] 0x100      │ │
│  │ [slcan      ▼] │ │  │ 0x100 - Throttle │   │ │ [x] 0x101      │ │
│  │                 │ │  │ ☑ Enabled  100ms │   │ │ [x] 0x102      │ │
│  │ Channel:        │ │  │ throttle: ═══○   │   │ │ ...            │ │
│  │ [/dev/ttyUSB0] │ │  └──────────────────┘   │ │                │ │
│  │                 │ │                         │ │ [Move Up]      │ │
│  │ Bitrate:        │ │  ┌──────────────────┐   │ │ [Move Down]    │ │
│  │ [1000000    ▼] │ │  │ 0x102 - RPM      │   │ │                │ │
│  │                 │ │  │ ☑ Enabled  100ms │   │ │ ──────────────│ │
│  │ [Connect]       │ │  │ rpm: ════════○   │   │ │                │ │
│  │ [Disconnect]    │ │  └──────────────────┘   │ │ Message Log    │ │
│  │                 │ │         ...              │ │ 10:15:32 TX... │ │
│  │ Status:         │ │                         │ │ 10:15:32 TX... │ │
│  │ ● Connected     │ │                         │ │ ...            │ │
│  │                 │ │                         │ │                │ │
│  │ ─────────────── │ │                         │ │ [Clear Log]    │ │
│  │ Protocol        │ │                         │ │ ☑ Auto-scroll  │ │
│  │ ○ Custom        │ │                         │ │                │ │
│  │ ● Link Generic  │ │                         │ │                │ │
│  │ ○ Link Generic2 │ │                         │ │                │ │
│  │ ─────────────── │ │                         │ │                │ │
│  │ Transmission    │ │                         │ │                │ │
│  │ [Start Sending] │ │                         │ │                │ │
│  │ [Stop]          │ │                         │ │                │ │
│  │ [Send Once]     │ │                         │ │                │ │
│  └─────────────────┘ └─────────────────────────┘ └────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Интерфейс приложения

### Левая панель — Подключение и управление

```
┌─ CAN Connection ────────────────────┐
│                                     │
│  Interface: [slcan            ▼]    │ ← Тип CAN адаптера
│  Channel:   [/dev/ttyUSB0      ]    │ ← Порт/канал
│  Bitrate:   [1000000          ▼]    │ ← Скорость CAN (1 Mbps!)
│                                     │
│  [Connect]  [Disconnect]            │ ← Подключение
│                                     │
│  Status: ● Connected                │ ← Статус
│                                     │
└─────────────────────────────────────┘

┌─ Protocol ──────────────────────────┐
│  ○ Custom Protocol                  │ ← CAN_PROTOCOL = 0
│  ● Link ECU Generic Dashboard       │ ← CAN_PROTOCOL = 1
│  ○ Link ECU Generic Dashboard 2     │ ← CAN_PROTOCOL = 2
└─────────────────────────────────────┘

┌─ Transmission ──────────────────────┐
│  Global Interval (ms): [100] [Apply]│ ← Общий интервал
│                                     │
│  [Start Sending]  ← Цикличная отправка
│  [Stop]           ← Остановка
│  [Send Once]      ← Отправить один раз
└─────────────────────────────────────┘

┌─ Statistics ────────────────────────┐
│  Messages sent: 1523                │
│  Rate: 70.2 msg/s                   │
│                                     │
│  [Reset Stats]                      │
└─────────────────────────────────────┘
```

### Центральная панель — Конфигурация сообщений

```
┌─ Message Configuration ─────────────────────────────────────────┐
│                                                                 │
│  ┌─ 0x100 - Throttle ─────────────────────────────────────────┐ │
│  │ ☑ Enabled   Interval (ms): [100]   (Throttle pedal)        │ │
│  │                                                             │ │
│  │ throttle: ════════════════════○════  [75] %                │ │
│  │           0%                   75%                    100% │ │
│  │                                                             │ │
│  │ Raw Data: 4B                                                │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 0x101 - Pedals ───────────────────────────────────────────┐ │
│  │ ☑ Enabled   Interval (ms): [100]   (Brake/Handbrake/Clutch)│ │
│  │                                                             │ │
│  │ brake:     ══════○════════════════  [25] %                 │ │
│  │ handbrake: ○══════════════════════  [0]  %                 │ │
│  │ clutch:    ══════════════════════○  [100] %                │ │
│  │                                                             │ │
│  │ Raw Data: 19 00 64                                          │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ┌─ 0x102 - RPM ──────────────────────────────────────────────┐ │
│  │ ☑ Enabled   Interval (ms): [50]    (Engine RPM)            │ │
│  │                                                             │ │
│  │ rpm: ══════════════════════════════════○  [5500] rpm       │ │
│  │      0                                 5500          10000 │ │
│  │                                                             │ │
│  │ Raw Data: 7C 15                                             │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│  ... (остальные сообщения)                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Правая панель — Последовательность и лог

```
┌─ Send Sequence ─────────────────────┐
│                                     │
│  [x] 0x100 - Throttle              │ ← Порядок отправки
│  [x] 0x101 - Pedals                │
│  [x] 0x102 - RPM                   │
│  [ ] 0x103 - Coolant               │ ← Отключено
│  [x] 0x104 - Oil Pressure          │
│  [x] 0x105 - Flags                 │
│  [x] 0x106 - Ignition              │
│                                     │
│  [Move Up]  [Move Down]  [Reset]   │
│                                     │
└─────────────────────────────────────┘

┌─ Message Log ───────────────────────┐
│                                     │
│ 10:15:32.123 TX 0x100 [1] 4B       │
│ 10:15:32.125 TX 0x101 [3] 19 00 64 │
│ 10:15:32.127 TX 0x102 [2] 7C 15    │
│ 10:15:32.223 TX 0x100 [1] 4B       │
│ 10:15:32.225 TX 0x101 [3] 19 00 64 │
│ ...                                 │
│                                     │
│ [Clear Log]  ☑ Auto-scroll         │
│                                     │
└─────────────────────────────────────┘
```

---

## Подключение

### Поддерживаемые адаптеры

| Interface | Адаптеры | Channel (Linux) | Channel (Windows) |
|-----------|----------|-----------------|-------------------|
| `slcan` | CANable, USBtin, UCAN | `/dev/ttyUSB0` | `COM3` |
| `socketcan` | can-utils, vcan | `can0`, `vcan0` | N/A |
| `pcan` | PEAK-System | `PCAN_USBBUS1` | `PCAN_USBBUS1` |
| `kvaser` | Kvaser | `0` | `0` |
| `vector` | Vector | `0` | `0` |
| `virtual` | Виртуальный (тест) | `test` | `test` |

### SLCAN адаптеры (рекомендуется)

SLCAN — самый распространённый и доступный тип USB-CAN адаптеров.

```bash
# Linux: найти порт
ls /dev/ttyUSB* /dev/ttyACM*

# macOS: найти порт
ls /dev/cu.usb*

# Windows: посмотреть в Device Manager
# Ports (COM & LPT) → USB Serial Port (COM3)
```

**Настройки:**
- Interface: `slcan`
- Channel: `/dev/ttyUSB0` или `COM3`
- Bitrate: `1000000` (1 Mbps)

### SocketCAN (Linux)

```bash
# Создать виртуальный CAN интерфейс
sudo modprobe vcan
sudo ip link add dev vcan0 type vcan
sudo ip link set up vcan0

# Использовать реальный адаптер
sudo ip link set can0 type can bitrate 1000000
sudo ip link set up can0
```

**Настройки:**
- Interface: `socketcan`
- Channel: `vcan0` или `can0`
- Bitrate: (игнорируется для socketcan)

### Виртуальный режим (без адаптера)

Для тестирования интерфейса без реального оборудования:

**Настройки:**
- Interface: `virtual`
- Channel: `test`
- Bitrate: `1000000`

Сообщения логируются, но не отправляются физически.

---

## Протоколы

### Выбор протокола

**Критически важно:** Протокол в эмуляторе должен совпадать с настройкой `CAN_PROTOCOL` в прошивке!

```cpp
// В src/config.h прошивки:
#define CAN_PROTOCOL 0  // Custom Protocol
#define CAN_PROTOCOL 1  // Link ECU Generic Dashboard (по умолчанию)
#define CAN_PROTOCOL 2  // Link ECU Generic Dashboard 2
```

### Custom Protocol (CAN_PROTOCOL = 0)

Простой протокол для кастомных ECU:

| ID | Название | Поля |
|----|----------|------|
| 0x100 | Throttle | throttle (0-100%) |
| 0x101 | Pedals | brake, handbrake, clutch (0-100%) |
| 0x102 | RPM | rpm (0-10000) |
| 0x103 | Coolant | coolant (0-150°C) |
| 0x104 | Oil Pressure | oil_pressure (0-10 bar) |
| 0x105 | Flags | rev_limiter, als_active (0/1) |
| 0x106 | Ignition | ignition (0/1) |

### Link ECU Generic Dashboard (CAN_PROTOCOL = 1)

Совместим с Link G4+, Fury X и другими ECU:

| ID | Название | Поля |
|----|----------|------|
| 0x5F0 | RPM & TPS | rpm (0-15000), tps (0-100%) |
| 0x5F1 | Fuel & Ignition | fuel_pressure, ign_timing |
| 0x5F2 | Pressures | map, baro, lambda |
| 0x5F3 | Temperatures | coolant, air_temp (-40...150°C) |
| 0x5F4 | Voltage & Flags | battery, rev_limiter, launch, ignition |
| 0x5F5 | Gear & Oil | gear (0-8), oil_pressure |
| 0x5F6 | Vehicle Speed | speed (0-300 km/h) |
| 0x5F7 | Throttle Sensors | tps1, tps2 |

### Link ECU Generic Dashboard 2 (CAN_PROTOCOL = 2)

Расширенный протокол с большим количеством данных:

| ID | Название | Поля |
|----|----------|------|
| 0x2000 | Engine Data 1 | rpm, tps, coolant, air_temp |
| 0x2001 | Engine Data 2 | map, battery, fuel_pressure, oil_pressure |
| 0x2002 | Engine Data 3 | lambda, ign_timing, fuel_level |
| 0x2003 | Engine Data 4 | boost_duty, idle_duty |
| 0x2004 | Vehicle Data 1 | speed, gear, launch_control, flat_shift |
| 0x2005 | Vehicle Data 2 | wheel_fl, wheel_fr, wheel_rl, wheel_rr |
| 0x2006 | Flags & Warnings | rev_limiter, ignition, engine_protection |
| 0x2007 | Analog Inputs | an1, an2, an3, an4 (0-5V) |

---

## Конфигурация сообщений

### Включение/выключение сообщений

```
┌─ 0x100 - Throttle ──────────────────┐
│ ☑ Enabled  ← Отключите, если не нужно
└─────────────────────────────────────┘
```

### Настройка интервала

Каждое сообщение имеет свой интервал отправки:

```
┌─ 0x102 - RPM ───────────────────────┐
│ Interval (ms): [50]  ← Быстрее для RPM
└─────────────────────────────────────┘

Рекомендации:
- RPM, Throttle: 20-50 ms (быстрая реакция)
- Температуры: 100-500 ms (медленное изменение)
- Флаги: 100 ms (нормальная скорость)
```

### Изменение значений

**Слайдеры** — для быстрой грубой настройки:
```
rpm: ══════════════════○════════════  [5500]
      0                              10000
          ← Перетащите мышью →
```

**Спинбоксы** — для точных значений:
```
rpm: [.....] [5500] [▲][▼]
              ↑
         Введите число или используйте стрелки
```

**Чекбоксы** — для булевых флагов:
```
☑ rev_limiter    ← Включено
☐ als_active     ← Выключено
```

### Просмотр raw данных

В каждом сообщении показаны сырые байты:

```
Raw Data: 7C 15     ← Hex представление
          ↓  ↓
         0x157C = 5500 (little-endian uint16)
```

---

## Примеры использования

### Пример 1: Тест отображения газа

**Цель:** Проверить зелёную полосу газа

```
1. Подключитесь к CAN адаптеру
2. Выберите ваш протокол
3. Найдите сообщение Throttle (0x100 или 0x5F0)
4. Включите только это сообщение
5. Отключите остальные (для изоляции теста)
6. Установите интервал 50 ms
7. Нажмите "Start Sending"
8. Двигайте слайдер throttle: 0% → 50% → 100%

Ожидаемый результат:
- LED лента показывает зелёную полосу
- Длина полосы пропорциональна проценту газа
```

### Пример 2: Тест отсечки (Rev Limiter)

**Цель:** Проверить жёлтое пульсирование при отсечке

```
1. Включите сообщения:
   - RPM (0x102 или 0x5F0)
   - Flags (0x105 или 0x5F4)
   - Ignition (0x106) — установите ignition = 1

2. Настройте значения:
   - rpm = 6500 (на уровне redline)
   - rev_limiter = ☑ (включено)

3. Нажмите "Start Sending"

Ожидаемый результат:
- LED лента пульсирует жёлтым цветом
- Частота пульсации ~4 Hz
```

### Пример 3: Тест паники низкого давления масла

**Цель:** Проверить красно-белую строб-вспышку

```
1. Включите сообщения:
   - Throttle — throttle = 50% (> 40%)
   - Oil Pressure — oil_pressure = 0.5 bar (< 2 bar)
   - Ignition — ignition = 1

2. Нажмите "Start Sending"

Ожидаемый результат:
- LED лента мигает красно-белым стробом
- Очень яркое и быстрое мигание (panic mode)
```

### Пример 4: Тест прогрева (Cold Start)

**Цель:** Проверить синее "дыхание" при холодном двигателе

```
1. Используйте пресет "Cold Start":
   - Меню → Presets → Cold Start

2. Или настройте вручную:
   - coolant = 20°C (< 60°C)
   - rpm = 1000
   - ignition = 1

3. Нажмите "Start Sending"

Ожидаемый результат:
- LED лента плавно пульсирует синим
- Эффект "дыхания" (breathing)
```

### Пример 5: Симуляция круга на треке

**Цель:** Протестировать реальный сценарий использования

```
Последовательность действий:

1. Старт (Idle):
   - rpm = 800, throttle = 0, brake = 0, speed = 0

2. Разгон:
   - Плавно увеличивайте rpm (800 → 6000)
   - Плавно увеличивайте throttle (0 → 100%)
   - speed растёт (0 → 150 km/h)
   - gear: 1 → 2 → 3 → 4

3. Торможение перед поворотом:
   - throttle = 0
   - brake = 80%
   - rpm падает

4. Прохождение поворота:
   - throttle = 30-50%
   - rpm = 4000-5000

5. Выход из поворота:
   - throttle = 100%
   - rpm растёт до отсечки
   - rev_limiter = 1 при rpm > 6500

Наблюдайте за LED:
- Зелёная полоса (газ)
- Красный оверлей (тормоз)
- Жёлтое пульсирование (отсечка)
- Градиент RPM (синий → жёлтый → красный)
```

### Пример 6: Автоматический тест всех визуализаций

**Цель:** Последовательно проверить все LED эффекты

```
Создайте тест-план:

1. [ ] Throttle bar — зелёная полоса
2. [ ] RPM gradient — синий → жёлтый
3. [ ] Brake overlay — красный при торможении
4. [ ] Clutch overlay — голубой справа
5. [ ] Handbrake overlay — фиолетовый слева
6. [ ] Rev limiter — жёлтое пульсирование
7. [ ] ALS — янтарное пульсирование
8. [ ] Cold engine — синее дыхание
9. [ ] Oil panic — красно-белый строб
10. [ ] Ignition standby — янтарное дыхание
11. [ ] Coolant indicator — последний LED (синий → зелёный → красный)
12. [ ] Shift light — синие вспышки около redline

Для каждого эффекта:
1. Настройте соответствующие параметры
2. Отправьте данные
3. Визуально проверьте LED
4. Отметьте ☑ в списке
```

---

## Продвинутые возможности

### Сохранение конфигурации

```
Меню → File → Save Configuration...

Сохраняется:
- Выбранный протокол
- Настройки подключения
- Значения всех полей
- Включённые/выключенные сообщения
- Интервалы отправки
- Порядок в последовательности

Формат: JSON файл
```

### Загрузка конфигурации

```
Меню → File → Load Configuration...

Полезно для:
- Быстрого переключения между тестами
- Воспроизведения сценариев
- Совместной работы (поделитесь .json файлом)
```

### Экспорт лога

```
Меню → File → Export Log...

Экспортирует все отправленные сообщения в текстовый файл:

CAN Bus Emulator Log - 2024-01-15 10:30:45
Protocol: Link ECU Generic Dashboard
------------------------------------------------------------
10:30:45.123 TX 0x5F0 [6] 20 03 00 00 E8 03
10:30:45.223 TX 0x5F3 [4] 52 03 FA 00
...
```

### Пресеты

Быстрые конфигурации в меню `Presets`:

| Пресет | RPM | Throttle | Coolant | Oil | Описание |
|--------|-----|----------|---------|-----|----------|
| Idle | 800 | 0% | 85°C | 3.5 bar | Холостой ход |
| Cruising | 3000 | 25% | 90°C | 4.5 bar | Равномерное движение |
| Hard Acceleration | 5500 | 100% | 95°C | 5.0 bar | Разгон |
| Rev Limiter | 6500 | 100% | 100°C | 5.5 bar | На отсечке |
| Cold Start | 1200 | 0% | 20°C | 4.0 bar | Холодный двигатель |
| Oil Warning | 4000 | 50% | 95°C | 0.5 bar | Низкое давление масла |

### Порядок отправки (Sequence)

Изменение приоритета сообщений:

```
1. Выберите сообщение в списке
2. Нажмите [Move Up] или [Move Down]
3. Сообщения вверху отправляются первыми

Зачем это нужно:
- RPM критичен → поставьте первым
- Температуры медленные → можно в конец
- Флаги важны → высокий приоритет
```

---

## Устранение проблем

### Ошибка "python-can not installed"

```bash
pip install python-can
```

### "Permission denied" на Linux

```bash
# Добавьте пользователя в группу dialout
sudo usermod -a -G dialout $USER

# Перезайдите в систему
logout
# или перезагрузите компьютер
```

### Адаптер не определяется

```bash
# Linux: проверьте подключение
dmesg | tail -20

# Должно быть:
# usb 1-1: new full-speed USB device
# ch341-uart ttyUSB0: ch341-uart converter detected
```

### LED не реагирует на сообщения

1. **Проверьте протокол:**
   - Протокол в эмуляторе = `CAN_PROTOCOL` в прошивке

2. **Проверьте bitrate:**
   - Должен быть 1000000 (1 Mbps)

3. **Проверьте Serial Monitor:**
   ```bash
   pio device monitor -b 115200
   ```
   Должны появляться строки:
   ```
   CAN: ID 0x100 DLC1 DATA 4B
   ```

4. **Проверьте подключение:**
   - CAN_H к CAN_H
   - CAN_L к CAN_L
   - GND к GND
   - Терминатор 120Ω

### SLCAN адаптер не отвечает

```bash
# Сброс адаптера (Linux)
stty -F /dev/ttyUSB0 raw

# Закрыть канал
echo -e "C\r" > /dev/ttyUSB0

# Установить скорость 1Mbps
echo -e "S8\r" > /dev/ttyUSB0

# Открыть канал
echo -e "O\r" > /dev/ttyUSB0
```

### Высокая нагрузка CPU

Уменьшите частоту отправки:
- Увеличьте интервалы до 100+ ms
- Отключите ненужные сообщения

---

## Приложение: Формат данных

### Порядок байт

Все многобайтовые значения в **little-endian**:

```
RPM = 5500 = 0x157C

В памяти:
Byte 0: 0x7C (младший байт)
Byte 1: 0x15 (старший байт)

Raw Data: 7C 15
```

### Масштабирование

Некоторые значения масштабируются перед отправкой:

| Параметр | Масштаб | Пример |
|----------|---------|--------|
| Coolant | ×10 | 85.0°C → 850 |
| Oil Pressure | ×10 | 4.5 bar → 45 |
| Lambda | ×100 | 1.00 → 100 |
| Battery | ×100 | 14.0V → 1400 |
| TPS | ×10 | 75.0% → 750 |

### Битовые флаги

Несколько флагов в одном байте:

```
Byte 2 в сообщении 0x5F4:

Bit 0: rev_limiter    (0x01)
Bit 1: launch_control (0x02)
Bit 2: flat_shift     (0x04)
Bit 7: ignition       (0x80)

Пример:
ignition ON + rev_limiter ON = 0x80 | 0x01 = 0x81
```

---

**Следующий шаг:** [Сценарии использования](USAGE_SCENARIOS.md)
