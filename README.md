# CAN LED status для TTGO T-CAN48

Пример прошивки для LilyGO® TTGO T-CAN48 (ESP32 + CAN) для отображения статусов автомобиля на адресной ленте WS2812/Neopixel. Лента меняет вид в зависимости от команд, приходящих по CAN. Дополнительно есть веб-интерфейс по Wi‑Fi для мониторинга текущих значений и последних кадров CAN.

## Возможности
- Скорость шины 1 Мбит/с (TWAI/CAN драйвер ESP32).
- Отрисовка состояния педали газа, тормоза, ручника, оборотов, температуры двигателя и отсечки.
- Отдельные подсветки для ALS (anti-lag), прогрева двигателя (t<60°C) и аварии по давлению масла при сильном газе.
- Настраиваемые пины CAN и пин ленты.
- Простой веб-сервер (HTTP) для просмотра текущего режима подсветки и последних принятых кадров (JSON API `/api/state`).
- Bluetooth‑конфигуратор (SPP) для настройки Wi‑Fi прямо с телефона/ноутбука.
- Простой протокол кадров — см. [`docs/CAN_PROTOCOL.md`](docs/CAN_PROTOCOL.md).

## Подключение
Схема подключения и советы приведены в [`docs/CONNECTIONS.md`](docs/CONNECTIONS.md). Кратко:
- CANH/CANL — к шине автомобиля, GND — к массе.
- DIN ленты — к `GPIO4`, питание ленты 5 В.
- Логи в Serial на 115200 бод + отладочные сообщения о принятых CAN кадрах.

## Сборка и прошивка
Используется PlatformIO.

```bash
# Установить зависимости и собрать
pio run

# Залить прошивку на плату (указать нужный порт)
pio run --target upload --upload-port /dev/ttyUSB0

# Открыть сериальный монитор
pio device monitor -b 115200
```

## Настройка логики
Ключевые параметры находятся в [`src/main.cpp`](src/main.cpp):
- `CAN_TX_PIN`, `CAN_RX_PIN` — пины CAN-трансивера.
- `LED_PIN`, `LED_COUNT`, `LED_BRIGHTNESS` — параметры ленты.
- `ID_*` — идентификаторы кадров протокола.
- `rpmRedline` в структуре `VehicleState` — точка срабатывания красной зоны.
- `WIFI_SSID`, `WIFI_PASSWORD` — параметры подключения к Wi‑Fi. После соединения откройте `http://<ip_устройства>/` для веб-страницы или `http://<ip_устройства>/api/state` для JSON.
- Bluetooth: устройство `TCAN48-CFG`. Подключитесь и отправляйте команды в виде текста: `HELP`, `STATUS`, `SSID <имя>`, `PASS <пароль>`, `SAVE` (сохраняет в flash). После смены SSID/пароля модуль пытается переподключиться к Wi‑Fi.

Для изменения визуализаций редактируйте функции `drawThrottleBar`, `drawRpmGradient`, `drawCoolantIndicator`, `applyBrakeOverlays`, `drawRevLimiter`.
